# This GitHub Actions workflow builds and tests the nanoGPT-C++ project on multiple platforms.
# It automatically downloads and caches the latest stable CPU version of LibTorch.
name: C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    # Run on Ubuntu, Windows, and macOS
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Latest LibTorch (CPU version)
      shell: bash
      run: |
        echo "Fetching the latest PyTorch version from PyPI..."
        # Use curl to get the JSON data and jq to parse the version string
        LATEST_VERSION=$(curl -s https://pypi.org/pypi/torch/json | jq -r .info.version)
        
        # PyTorch download links sometimes have a '+cpu' suffix, which we can strip for the URL
        PYTORCH_VERSION=$(echo $LATEST_VERSION | cut -d'+' -f1)
        
        echo "Latest stable PyTorch version is ${PYTORCH_VERSION}"

        # Construct the correct URL based on the runner's OS
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          URL="https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-${PYTORCH_VERSION}%2Bcpu.zip"
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          URL="https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-${PYTORCH_VERSION}%2Bcpu.zip"
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          URL="https://download.pytorch.org/libtorch/cpu/libtorch-macos-${PYTORCH_VERSION}.zip"
        fi
        
        echo "Downloading LibTorch from $URL"
        curl --retry 3 -L -o libtorch.zip "$URL"
        
        echo "Unzipping LibTorch..."
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          powershell -Command "Expand-Archive -Path libtorch.zip -DestinationPath ."
        else
          unzip libtorch.zip
        fi
        
        # Set LIBTORCH_PATH environment variable for subsequent steps
        echo "LIBTORCH_PATH=$PWD/libtorch" >> $GITHUB_ENV

    - name: Setup Python and Prepare Dataset
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - run: |
        echo "Cloning original nanoGPT repo to prepare data..."
        git clone https://github.com/karpathy/nanoGPT.git
        pip install -r nanoGPT/requirements.txt
        python nanoGPT/data/shakespeare_char/prepare.py
        echo "Copying prepared data into project..."
        mkdir -p data
        cp -r nanoGPT/data/shakespeare_char ./data/

    - name: Download cxxopts header
      shell: bash
      run: |
        mkdir -p src
        curl -L -o src/cxxopts.hpp https://raw.githubusercontent.com/jarro2783/cxxopts/master/include/cxxopts.hpp

    - name: Configure CMake
      # Use the LIBTORCH_PATH environment variable we set in the download step.
      run: >
        cmake -B build
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DCMAKE_PREFIX_PATH=${{ env.LIBTORCH_PATH }}
        -S ${{ github.workspace }}

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }}

    - name: Run Smoke Test
      working-directory: build
      run: |
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          ./Release/nanogpt_cpp.exe --mode=train --max_iters=10 --device=cpu --eval_iters=5
        else
          ./nanogpt_cpp --mode=train --max_iters=10 --device=cpu --eval_iters=5
        fi
